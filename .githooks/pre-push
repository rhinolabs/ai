#!/bin/bash

# Get the remote and branch being pushed to
remote="$1"
url="$2"

# Read stdin to get the local/remote refs
while read local_ref local_sha remote_ref remote_sha; do
    # Skip delete pushes
    if [ "$local_sha" = "0000000000000000000000000000000000000000" ]; then
        continue
    fi

    # Determine the range of commits being pushed
    if [ "$remote_sha" = "0000000000000000000000000000000000000000" ]; then
        # New branch ‚Äî compare against main
        range="origin/main...$local_sha"
    else
        range="$remote_sha..$local_sha"
    fi

    # Get list of changed files
    changed_files=$(git diff --name-only "$range" 2>/dev/null)

    if [ -z "$changed_files" ]; then
        echo "‚úÖ No file changes detected. Proceeding with push..."
        exit 0
    fi

    # Check if ALL changed files are non-code (docs, config, etc.)
    has_code_changes=false

    for file in $changed_files; do
        ext="${file##*.}"
        # Check by extension
        case "$ext" in
            md|txt|mdx) continue ;;
        esac
        # Check by path
        case "$file" in
            docs/*|README*|LICENSE*|CHANGELOG*|*.md) continue ;;
        esac
        # If we get here, it's a code file
        has_code_changes=true
        break
    done

    if [ "$has_code_changes" = false ]; then
        echo "üìÑ Only non-code files changed (docs, config, etc.). Skipping tests."
        echo "   Changed files:"
        for file in $changed_files; do
            echo "     - $file"
        done
        echo ""
        echo "‚úÖ Proceeding with push..."
        exit 0
    fi

    # Code files changed ‚Äî run full test suite
    echo "üß™ Running all tests before push..."
    echo ""

    make test

    EXIT_CODE=$?

    if [ $EXIT_CODE -ne 0 ]; then
        echo ""
        echo "‚ùå PUSH BLOCKED: Tests failed!"
        echo "   Fix the failing tests before pushing."
        exit 1
    fi

    echo ""
    echo "‚úÖ All tests passed. Proceeding with push..."
    exit 0
done
